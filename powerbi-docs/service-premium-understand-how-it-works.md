---
title: Использование и оптимизация памяти емкости Power BI Premium
description: Информация об использовании и оптимизации памяти емкости Power BI Premium.
ms.date: 10/18/2018
ms.topic: conceptual
ms.service: powerbi
ms.component: powerbi-admin
ms.author: mblythe
ms.reviewer: mblythe
author: mgblythe
manager: kfile
ms.openlocfilehash: 99c84aff932c7ce56a4aaa81d71e4583bce3e4c2
ms.sourcegitcommit: a764e4b9d06b50d9b6173d0fbb7555e3babe6351
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/22/2018
ms.locfileid: "49641756"
---
# <a name="microsoft-power-bi-premium-capacity-resource-management-and-optimization"></a>Использование и оптимизация ресурсов емкости Microsoft Power BI Premium

В этой статье описывается управление ресурсами в Power BI Premium. Здесь также содержатся примеры и сведения об устранении неполадок. Общие сведения см. в статье [Что такое Power BI Premium?](service-premium.md).

## <a name="premium-capacity-memory-management"></a>Управление памятью емкости Premium

 Память емкости Premium используется для:

* наборов данных, которые загружаются в память;
* обновлений наборов данных (запланированных и по запросу);
* запросов отчетов.

Когда поступает запрос к набору данных, опубликованному в емкости Premium, набор данных загружается в память из постоянного хранилища (этот процесс называется загрузкой образа). Сохранение набора данных в памяти помогает быстрее создавать ответы на дальнейшие запросы к этому набору данных. Помимо хранения загруженного набора данных, некоторый объем памяти требуется для запросов отчетов и обновлений набора данных.

### <a name="dataset-memory-estimation"></a>Оценка памяти для набора данных

При попытке загрузить набор данных в память Power BI оценивает объем памяти, который потребуется для выполнения запрошенной команды к этому набору данных. Наборы данных в памяти обычно имеют больший размер, чем при их хранении на диске. При обновлении набора данных для Power BI требуется как минимум в два раза больше памяти, чем для набора данных в неактивном состоянии.

### <a name="overcommitting-capacity-eviction-and-reloading-of-datasets"></a>Избыточное выделение памяти, вытеснение и перезагрузка наборов данных

Power BI Premium позволяет использовать *избыточное выделение* емкости. Например, вы можете опубликовать больше наборов данных, чем может поместиться в емкости. Если для опубликованных наборов данных в определенный момент потребуется больше памяти, чем доступно в емкости, часть наборов данных перемещается в постоянное хранилище. Постоянное хранилище выделяется из общего объема 100 ТБ, связанного с каждой из ваших емкостей.

Как же выбираются наборы данных для хранения в памяти и что происходит с другими наборами данных? Как указано выше, при получении запроса к набору данных этот набор данных загружается в память (загрузка образа). Запросами считаются запросы отчета и операции обновления. Но избыточное выделение емкости может привести к нехватке памяти. При нехватки памяти узел *вытесняет* один или несколько наборов данных из памяти. Наборы данных в неактивном состоянии (для которых не выполняются запросы или обновление) вытесняются в первую очередь. Для них применяется порядок "недавно использовавшиеся" (LRU). Когда поступит новая команда для вытесненного набора данных, служба попытается повторно загрузить его в память, что снова может инициировать вытеснение других наборов данных. Такое поведение позволяет эффективнее использовать память, так как емкость обслуживает намного больше наборов данных, чем помещается в память.

Загрузка набора данных в память требует довольно много ресурсов. В зависимости от размера набора данных эта операция занимает от пары секунд до десятков секунд или даже нескольких минут, если объем набора данных составляет примерно 10 ГБ. На уровне емкости Premium выполняется попытка минимизировать количество загрузок для каждого набора данных, как можно дольше сохраняя в памяти самые активно используемые из них. Когда требуется дополнительная память, некоторые наборы данных вытесняются. Система пытается выбрать для вытеснения тот набор данных, который меньше повлияет на взаимодействие с пользователем. Когда требуется дополнительная память, некоторые наборы данных вытесняются. Система пытается выбрать для вытеснения тот набор данных, который меньше повлияет на взаимодействие с пользователем. Например, система не будет вытеснять наборы данных, которые активно использовались в течение нескольких последних минут. Для этих наборов данных высока вероятность повторных запросов.

Сам процесс вытеснения происходит быстро. Если набор данных в период вытеснения не используется активно, пользователь не заметит существенной разницы. Но если одновременно активно используется так много наборов данных, что для их хранения не хватает памяти, вытеснение будет выполняться очень часто. Это может привести к так называемой "пробуксовке", при которой наборы данных постоянно вытесняются и загружаются заново. Такая ситуация существенно снижает время отклика и производительность работы.

### <a name="dataset-refresh-memory-requirement-competing-with-an-active-dataset-memory-requirement"></a>Конфликт между требованиями к памяти для обновления наборов и для использования активных наборов данных

Наборы данных могут обновляться по расписанию или по запросу пользователей. Как указано ранее, для полного обновления требуется как минимум в два раза больше памяти, чем для загруженных неактивных наборов данных. Перед началом обновления проводится оценка требуемой памяти. Если общий объем требуемой памяти превышает доступный в емкости, происходит вытеснение некоторых наборов данных. Опять же, вытеснение основано на LRU.

Если вытеснение не позволяет освободить необходимый объем памяти, обновления помещаются в очередь для повторной попытки. Служба повторяет попытки обновления, пока не сможет выполнить его успешно или пока не начнется новое действие обновления.

Если поступает интерактивный запрос к любому набору данных в емкости, для загрузки которого не хватает памяти из-за текущего процесса обновления, такой запрос завершается ошибкой и пользователю приходится его повторять.

## <a name="cpu-resource-management-in-premium-capacity"></a>Управление ресурсами ЦП в емкости Premium

Есть два основных потребителя ресурсов ЦП:

* запросы из отчетов;
* обновление (обработка).

### <a name="queries-from-reports"></a>Запросы из отчетов

Запросы отчетов используют ресурсы ЦП, выделенные для вашей емкости. Если отчет содержит неэффективные запросы или с ним одновременно работают много пользователей, он может потреблять значительный объем ресурсов ЦП. Существующая емкость может оказаться недостаточной для обработки нагрузки.

### <a name="refresh-parallelization-policy"></a>Политика распараллеливания обновлений

Объем памяти — не единственный ресурс, который может ограничивать обновление наборов данных. Еще одним фактором является количество виртуальных ядер на сервере. Так как каждая операция обновления использует определенное количество виртуальных ядер, одновременно может выполняться ограниченное количество обновлений. Ограничения для каждого номера SKU описаны в приведенной ниже таблице. Любые обновления вне этих пределов помещаются в очередь.

 | Номер SKU | Серверные виртуальные ядра | Параллелизм обновления модели |
 | --- | --- | --- |
 | A1  | 0,5  | 1  |
 | A2  | 1  | 2  |
 | A3  | 2  | 3  |
 | A4  | 4  | 6  |
 | A5  | 8  | 12  |
 | A6  | 16  | 24  |
 | EM1  | 0,5  | 1  |
 | EM2  | 1  | 2  |
 | EM3  | 2  | 3  |
 | P1  | 4  | 6  |
 | P2  | 8  | 12  |
 | P3  | 16  | 24  |
 | P4  | 32  | 48  |
 | P5  | 64  | 96  |

 > [!TIP]
> Если обновления задерживаются, проверьте допустимое число параллельных обновлений для используемой емкости.

## <a name="example-scenarios"></a>Примеры сценариев

Далее описаны некоторые распространенные сценарии и действия, выполняемые службой.

**Двадцать запланированных обновлений запускаются одновременно**. Power BI пытается запустить первые *x* обновлений одновременно. Значение *x* зависит от политики распараллеливания обновлений для используемого номера SKU. Если Power BI не сможет получить достаточный объем памяти за счет вытеснения неактивных (давно не использовавшихся) наборов данных, не все эти *x* обновлений будет запущены одновременно. Те из них, которые запустить не удается, помещаются в очередь до появления возможности запуска.

**Два обновления выполняются одновременно, но памяти хватает только для завершения одного из них**. Будет запущено только то обновление, которое можно завершить. Для второго попытка запуска будет повторена позже.

**Поступают запросы к большому количеству наборов данных одновременно с обновлением нескольких наборов данных**. Если памяти недостаточно, Power BI пытается остановить активные обновления, отдавая приоритет обработке запросов. Это снижает производительность обновлений.

**Для обновления набора данных требуется больше памяти, чем доступно при текущей емкости**. Обновление завершится ошибкой. При этом не выполняются попытки получить больше памяти за счет вытеснения наборов данных.

**Выполняется обновление одного набора данных, которое приводит к резкому увеличению объема потребляемой памяти**. Если этот показатель превышает объем памяти, который можно освободить путем вытеснения неактивных наборов данных, это обновление запускается повторно позднее, когда будет доступен достаточный объем памяти для обработки.

**Выполняется запрос к набору данных, для которого невозможно получить достаточно памяти путем вытеснения всех неактивных наборов данных и обновлений**. Такой запрос завершается ошибкой. Для выполнения рабочих нагрузок с такими требованиями нужно приобрести дополнительную емкость.

## <a name="troubleshooting-and-testing"></a>Устранение неполадок и тестирование

Если отчеты работают медленно или не отвечают, прежде всего проверьте их работу с одним пользователем. Затем постепенно увеличивайте пользовательскую нагрузку, чтобы определить предел. Во многих случаях тонкая настройка DAX (запросов отчетов) позволяет значительно повысить производительность отчетов. Настройка запросов также увеличивает количество одновременно работающих пользователей при той же емкости. [Ведите наблюдение за емкостью](service-admin-premium-monitor-capacity.md), чтобы выявить возможные проблемы с производительностью.

Емкость Power BI Embedded в Azure позволяет тестировать различные номера SKU и выбрать оптимальный SKU уровня Premium для ожидаемой рабочей нагрузки. Номер SKU Power BI Embedded A4 аналогичен размеру P1, A5 = P2 и A6 = P3. В Azure можно легко переключаться между номерами SKU путем вертикального масштабирования на портале Azure. Выбрав номер SKU, который лучше всего подходит для вашей рабочей нагрузки, и завершив все тесты с ним, вы можете удалить этот SKU.

В некоторых случаях файл Power BI Desktop (PBIX) модели на локальном компьютере и проверка потребления памяти и ЦП дает много информации о возникшей проблеме. Для небольших моделей можно попробовать следующее: откройте ее, обновите и отправьте запрос с локального компьютера. Для очень крупных моделей такой метод бесполезен. Проверьте размер модели, потребление памяти и ЦП при открытии модели. Попробуйте обновить страницу и повторить запрос. С помощью диспетчера задач проверьте потребление ресурсов ЦП и памяти для локального файла. В некоторых случаях эти данные на локальном компьютере позволяют определить, что низкие уровни емкости Premium (например, P1 и P2) будут недостаточными для вашего решения.

## <a name="next-steps"></a>Дальнейшие действия

[Управление емкостью в Power BI Premium и Power BI Embedded](service-admin-premium-manage.md)