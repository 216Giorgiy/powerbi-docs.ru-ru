---
title: "DirectQuery для SAP HANA в Power BI"
description: "Аспекты использования DirectQuery с SAP HANA"
services: powerbi
documentationcenter: 
author: davidiseminger
manager: kfile
backup: 
editor: 
tags: 
qualityfocus: no
qualitydate: 
ms.service: powerbi
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: powerbi
ms.date: 02/05/2018
ms.author: davidi
LocalizationGroup: Connect to data
ms.openlocfilehash: cd266118fa560b3d637a85b352f8c1f03d137ec6
ms.sourcegitcommit: 88c8ba8dee4384ea7bff5cedcad67fce784d92b0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/24/2018
---
# <a name="directquery-and-sap-hana"></a>DirectQuery и SAP HANA
Вы можете подключиться к источникам данных **SAP HANA** напрямую с помощью **DirectQuery**. К HANA можно подключиться двумя способами:

* **Определение HANA в качестве многомерного источника (по умолчанию).** Сейчас это параметр по умолчанию, который доступен в предварительной версии. В этом случае поведение будет таким же, как при подключении Power BI к другим многомерным источникам, таким как SAP Business Warehouse или Analysis Services. Если при подключении к HANA использовать этот параметр, выбирается одно представление аналитики или вычисления и все меры, иерархии и атрибуты этого представления будут доступны в списке полей. При создании визуализации данные вычислений будут всегда извлекаться из HANA. Это стандартный рекомендуемый подход.

* **Определение HANA в качестве реляционного источника.** В этом случае HANA в Power BI считается реляционным источником. Такой подход обеспечивает большую гибкость. Но необходимо соблюдать осторожность, чтобы вычисление мер выполнялось правильно и не возникали проблемы с производительностью.

Способ подключения определяется с помощью глобального параметра средства. Чтобы установить этот параметр, последовательно выберите **Файл > Параметры и настройки**, **Параметры > DirectQuery**, а затем выберите параметр **Считать HANA реляционным источником**, как показано на следующем изображении: 

![](media/desktop-directquery-sap-hana/directquery-sap-hana_01a.png)

Обратите внимание, что **соединитель SAP HANA** на данный момент находится на этапе **предварительной версии** и его нужно включить, чтобы отобразился упомянутый выше параметр. Чтобы включить новую предварительную версию SAP HANA, выберите ее в разделе **Параметры > Предварительная версия функций**, как показано на следующем рисунке.

![](media/desktop-directquery-sap-hana/directquery-sap-hana_01b.png)

Параметр "Считать HANA реляционным источником" управляет подходом для всех *новых* подключений. Он не влияет ни на подключения HANA в текущем отчете, ни на подключения в других отчетах, которые открыты. Если возле этого параметра флажок снят, после добавления нового подключения к HANA с помощью окна **получения данных**, это подключение будет выполняться с параметром "Считать HANA многомерным источником". Но если открыт другой отчет, который тоже подключается к HANA, он будет работать с учетом параметра, установленного *при создании этого отчета*. Это означает, что все отчеты, подключенные к HANA, которые созданы до февраля 2018 г., будут определять HANA как реляционный источник. 

Два подхода формируют кардинально разное поведение. Поэтому для существующего отчета нельзя изменить один подход на другой. 

Рассмотрим подробнее каждый из этих подходов.

## <a name="treat-hana-as-a-multi-dimensional-source-default"></a>Определение HANA в качестве многомерного источника (по умолчанию)

Это поведение по умолчанию, которое сейчас находится на этапе предварительной версии. Чтобы включить эту предварительную версию функции, следуйте инструкциям из предыдущего раздела. 

После того как вы включите **предварительную версию** функции, последовательно выбрав **Параметры > Предварительная версия функций** (см. соответствующие инструкции в предыдущем разделе), для всех новых подключений к HANA этот метод подключения будет стандартным. То есть HANA будет считаться многомерным источником. Чтобы при подключении платформа HANA определялась как реляционный источник, последовательно выберите **Файл > Параметры и настройки** и установите флажок в списке **DirectQuery > Считать HANA реляционным источником**. Пока эта функция находится в **предварительной версии**, отчеты, созданные с помощью подхода с многомерным источником, *нельзя* будет публиковать в службе Power BI. Это действие будет приводить к ошибкам при открытии отчета в службе Power BI.  

Ниже описано, как работает подключение к HANA как к многомерному источнику.

* В **навигаторе получения данных** можно выбрать одно представление HANA. Нельзя выбрать отдельные меры или атрибуты. Во время подключения запросы не определяются. Это поведение отличается от импорта данных или использования DirectQuery при обработке HANA как реляционного источника. Это также означает, что нельзя непосредственно использовать SQL-запрос HANA, если выбран этот способ подключения.

* Все меры, иерархии и атрибуты из выбранного представления будут отображаться в списке полей. 

* Так как мера используется в визуализации, к HANA будет направлен запрос для получения значения меры на уровне агрегирования, который требуется для визуализации. Поэтому при работе с неаддитивными мерами (счетчики, коэффициенты и т. д.) все операции агрегирования создает HANA, и после этого службе Power BI не нужно создавать их. 

* Чтобы всегда получать из HANA правильные значения вычислений, необходимо соблюдать некоторые ограничения. Например, нельзя добавлять вычисляемые столбцы и объединять данные из нескольких представлений HANA в одном отчете. 

Если при подключении к HANA эта платформа считается многомерным источником, отсутствует гибкость, доступная при использовании альтернативного *реляционного* подхода. Но этот способ проще использовать, он гарантирует правильные значения вычислений при работе с более сложными мерами HANA и в целом обеспечивает более высокую производительность. 

Список **Поле** будет включать все меры, атрибуты и иерархии из представления HANA. Обратите внимание на поведение при использовании этого метода подключения.

* Атрибуты, которые включены хотя бы в одну иерархию, будут скрыты по умолчанию. Но если в контекстном меню списка полей выбрать параметр **Показать скрытые**, эти атрибуты отобразятся. При необходимости в этом же контекстном меню можно сделать атрибуты видимыми.

* В HANA можно определить атрибут для использования другого атрибута в качестве его метки. Например, атрибут **Product** со значениями 1, 2, 3 и т. д. можно использовать в качестве метки атрибута **ProductName** со значениями "Велосипед", "Рубашка", "Перчатки" и т. д. В этом случае одно поле **Product** будет отображаться в списке полей, значениями которых будут метки "Велосипед", "Рубашка", "Перчатки" и т. д. Но эти значения будут отсортированы по уникальности и по ключевым значениям 1, 2, 3. Кроме того, можно создать скрытый столбец **Product.Key**, чтобы при необходимости предоставлять доступ к базовым значениям ключа. 

Все переменные, определенные в базовом представлении HANA, отображаются во время подключения, и для них можно ввести необходимые значения. Эти значения можно впоследствии изменить. Для этого выберите на ленте **Изменить запросы**, а затем в раскрывающемся меню выберите **Изменить переменные**. 

Разрешаются более строгие операции моделирования, чем при стандартном использовании DirectQuery. Это нужно, чтобы из HANA можно было всегда получить правильные данные вычислений. Но при этом можно вносить дополнения и изменения, например определять меры, переименовывать и скрывать поля, выбирать форматы отображения. Все изменения сохраняются при обновлении, и неконфликтующие изменения, внесенные в представление HANA, будут применены. 

### <a name="additional-modelling-restrictions"></a>Дополнительные ограничения моделирования

Ниже перечислены основные дополнительные ограничения моделирования при подключении к SAP HANA с помощью DirectQuery в Power BI (HANA считается многомерным источником): 

* **Вычисляемые столбцы не поддерживаются.** Возможность создания вычисляемых столбцов отключена. Это также означает, что группирование и кластеризация, которые создают вычисляемые столбцы, недоступны.
* **Дополнительные ограничения для мер.** На выражения DAX, которые могут использоваться в мерах, накладываются дополнительные ограничения. Они зависят от уровня поддержки, предоставляемого SAP HANA.
* **Определение связей не поддерживается.** В отчете можно подать запрос только на одно представление. Поэтому определение связей не поддерживается.
* **Нет представления данных.** **Представление данных** обычно отображает детальные данные в таблицах. Учитывая характер источников OLAP, таких как SAP HANA, это представление недоступно для SAP HANA.
* **Сведения о столбцах и мерах фиксированы.** Список столбцов и мер, которые видны в списке полей, фиксируется базовым источником и не может быть изменен. Например, нельзя удалить столбец или изменить его тип данных. Но его можно переименовать.
* **Дополнительные ограничения в DAX.** Для функций DAX, которые могут использоваться в определениях мер, накладываются дополнительные ограничения в соответствии с ограничениями в источнике. Например, нельзя использовать агрегатную функцию для таблицы.

### <a name="additional-visualization-restrictions"></a>Дополнительные ограничения визуализации

Ниже перечислены ограничения для визуализаций при подключении к SAP HANA с помощью DirectQuery в Power BI (HANA считается многомерным источником): 
* **Агрегирование столбцов не поддерживается.** Нельзя изменить агрегирование столбца для визуализации. Всегда указано значение *Не вычислять итоговое значение*.

## <a name="treat-hana-as-a-relational-source"></a>Определение HANA в качестве реляционного источника 

Если выбрать подключение к HANA как реляционному источнику, будут доступны дополнительные гибкие возможности. Например, можно создать вычисляемые столбцы, включить данные из нескольких представлений HANA и создать связи между итоговыми таблицами. Но при таком использовании SAP HANA важно понимать, как обрабатываются подключения, чтобы обеспечить следующее поведение: 

* результаты отображаются правильно, если представление SAP HANA содержит неаддитивные меры (например, число или среднее значение различных объектов, а не обычные сумы);
* полученные запросы эффективны.

Когда запрос, определенный в разделе **получения данных** или **редакторе запросов**, выполняет агрегирование, сначала необходимо уточнить поведение реляционного источника, такого как SQL Server. В следующем примере запрос, определенный в **редакторе запросов**, возвращает значение средней цены по *ProductID*.  

![](media/desktop-directquery-sap-hana/directquery-sap-hana_01.png)

Если импортировать данные в Power BI (вместо использования DirectQuery), мы получим следующие результаты:

* Данные будут импортированы на уровне агрегата, определенного запросом, созданным в **редакторе запросов**. Например, средняя цена продукта. В результате мы получаем таблицу с двумя столбцами, *ProductID* и *AveragePrice*, которые можно использовать в визуальных элементах.
* В визуальном элементе любое последующее агрегирование (например, *Sum*, *Average*, *Min* и другие) выполняется над импортируемыми данными. Например, если включить *AveragePrice* в визуализацию, по умолчанию будет выполняться вычисление *Sum* и возвращаться сумма *AveragePrice* для каждого *ProductID*. В нашем примере это 13,67. Это же правило применяется для альтернативных агрегатных функций (*Min*, *Average* и т. д.), используемых в визуальных элементах. Например, значение *Average* колонки *AveragePrice* возвращает среднее значение для 6,66, 4 и 3, которое равно 4,56, а не среднее значение столбца *Price* с 6 записями в базовой таблице, равное 5,17.
  
Если вместо импорта использовать **DirectQuery** (для того же реляционного источника), будет применена та же семантика и результаты будут совпадать.  

* Рассматривая тот же запрос, точно такие же логические данные будут представлены на уровне отчета, хотя фактически они не импортированы.

* В визуальном элементе любое последующее агрегирование (*Sum*, *Average*, *Min* и другие) снова выполняется над логической таблицей из запроса. Как видим, визуальный элемент, который содержит *среднее значение* записей в колонке *AveragePrice*, возвращает то же значение — 4,56.
  
Теперь посмотрим, как работает SAP HANA, если при подключении она определена как реляционный источник. В SAP HANA Power BI может работать с *аналитическими представлениями* и *представлениями вычисления*, которые могут содержать меры. Но подход к использованию SAP HANA основан на тех же принципах, которые описаны ранее в этом разделе. Запрос в разделе **получения данных** или **редакторе запросов** определяет доступные данные, после чего любая последующая операция агрегирования в визуализации выполняется с использованием этих данных. Это же правило применяется для импорта и DirectQuery.  
Однако принимая во внимание особенности HANA, запрос, определенный в исходном диалоговом окне **Получение данных** или **редакторе запросов**, всегда статистический и, как правило, включает меры, где фактическое используемое агрегирование определяется представлением HANA.

Эквивалентом приведенного выше примера SQL Server является представление HANA, содержащее записи *ID*, *ProductID*, *DepotID* и меры, включая *AveragePrice*, определенную в представлении как *среднее значение цены*.  
    
Если в разделе **получения данных** выбраны элементы для меры **ProductID** и **AveragePrice**, по этому представлению выполняется запрос на вычисление данных (в примере выше для простоты используется псевдо-SQL, который не соответствует точному синтаксису HANA SQL). После чего все последующие агрегаты, определенные в визуальном элементе, создают сводку результатов этого запроса. Как указано ранее для SQL Server, это касается и импорта, и DirectQuery. Обратите внимание, что в DirectQuery запрос из **Получение данных** или **редактора запросов** будет использоваться в подзапросах в рамках одного запроса, отправленного HANA. Таким образом, нельзя утверждать, что все данные будут считываться перед дальнейшим агрегированием.  

Исходя из указанного выше, при использовании DirectQuery для подключения к HANA нужно учитывать следующие важные моменты:  

* Необходимо уделять внимание последующему агрегированию в визуальных элементах, если меры в HANA неаддитивные (например, не являются простым агрегатом *Sum*, *Min* или *Max*).

* В представлении **Получение данных** или **редакторе запросов**, чтобы получить необходимые данные, должны быть включены только необходимые столбцы, что отражает тот факт, что результатом должен быть подходящий запрос, который можно отправить HANA. Например, если выбраны десятки столбцов, потому что они могут понадобиться для последующих визуальных элементов, то даже простой визуальный элемент для DirectQuery будет означать, что статистический запрос, используемый в подзапросе, содержит десятки столбцов, что снижает производительность.
  
Давайте рассмотрим пример. В следующем примере, если выбрать пять столбцов (**CalendarQuarter**, **Color**, **LastName**, **ProductLine**, **SalesOrderNumber**) в диалоговом окне **получения данных**, а также меру *OrderQuantity*, при дальнейшем создании простой визуализации с Min OrderQuantity будет выполняться указанный ниже запрос SQL для HANA. Затененная часть — это подвыборка с запросом из диалогового окна **получения данных** / **редактора запросов**. Если подвыборка выдаст результат с очень большим количеством элементов, это может значительно снизить производительность HANA.  

![](media/desktop-directquery-sap-hana/directquery-sap-hana_03.png)

   
Поэтому рекомендуем выбирать в окне **получения данных** или в **редакторе запросов** только необходимые элементы, которые сформируют правильный запрос к HANA.  

## <a name="best-practices"></a>Советы и рекомендации 

При использовании обоих методов подключения к SAP HANA рекомендации для DirectQuery также применимы к HANA (особенно указания, связанные с обеспечением высокой производительности). Эти рекомендации подробно описаны в статье об [использовании DirectQuery в Power BI](desktop-directquery-about.md).
   
## <a name="limitations"></a>Ограничения

В следующем списке перечислены все функции SAP HANA, которые поддерживаются не полностью или работают иначе при использовании Power BI. 

* **Иерархии дочерних элементов родительских элементов.** Иерархии дочерних элементов родительских элементов не отображаются в Power BI.
Это связано с тем, что Power BI обращается к HANA с помощью интерфейса SQL, а к иерархиям дочерних элементов родительских элементов нельзя получить полный доступ через SQL.
* **Другие метаданные иерархии.**  Базовая структура иерархий отображается в Power BI, но некоторые метаданные иерархии (например, метаданные, управляющие поведением неоднородных иерархий) не будут работать.
Это ограничение также связано с интерфейсом SQL.
* **Подключение с помощью SSL.** Нельзя подключиться к экземплярам SAP HANA, настроенным для использования протокола SSL.
Поддержка для представлений атрибутов в Power BI может применяться к представлениям аналитики и вычислений, но не применяется напрямую к представлениям атрибутов.
* **Поддержка объектов каталога.** Power BI не может подключаться к объектам каталога.
* **Изменение переменных после публикации.** Переменные HANA нельзя изменить непосредственно в службе Power BI после публикации отчета. 
 
## <a name="known-issues"></a>Известные проблемы 
Ниже перечислены все известные проблемы, которые могут возникнуть при подключении к SAP HANA (DirectQuery) с помощью Power BI. 

* **Проблема с HANA при выполнении запроса счетчиков и других мер.**  Если при подключении к представлению аналитики мера счетчиков и другая мера коэффициента включены в одну и ту же визуализацию, из HANA возвращаются неправильные данные. Эта проблема описана в Примечании SAP 2128928 (Неожиданный результат при выполнении запроса вычисляемого столбца и счетчика). Мера коэффициента в этом случае будет неправильной. 

* **Несколько столбцов Power BI из одного столбца HANA.** В некоторых представлениях вычислений, где столбец HANA используется в нескольких иерархиях, он отображается как два отдельных атрибута. Это приводит к тому, что в Power BI создаются два столбца.  Эти столбцы скрыты по умолчанию, но все запросы, включающие иерархии или непосредственно столбцы, работают правильно. 
 
## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о DirectQuery см. в следующих статьях:

* [Power BI и DirectQuery](desktop-directquery-about.md)
* [Источники данных, поддерживаемые DirectQuery](desktop-directquery-data-sources.md)
* [Использование DirectQuery и SAP Business Warehouse (BW)](desktop-directquery-sap-bw.md)
* [Локальный шлюз данных](service-gateway-onprem.md)

